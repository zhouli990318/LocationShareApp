<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="LocationShareApp.Views.UserManagementPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:LocationShareApp.ViewModels"
             xmlns:services="clr-namespace:LocationShareApp.Services"
             x:DataType="viewmodels:UserManagementViewModel"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,*">
        
        <!-- æ·»åŠ ç”¨æˆ·è¡¨å• -->
        <Frame Grid.Row="0"
               Style="{StaticResource MaterialTopAppBar}">
            <StackLayout Spacing="16">
                
                <Label Text="æ·»åŠ æ–°ç”¨æˆ·"
                       Style="{StaticResource MaterialHeadline2}" />

                <!-- ç»‘å®šç è¾“å…¥ -->
                <StackLayout Spacing="8">
                    <Label Text="ç»‘å®šç "
                           Style="{StaticResource MaterialSubtitle1}" />
                    <Frame Style="{StaticResource MaterialCard}">
                        <Entry Text="{Binding BindingCode}"
                               Placeholder="è¯·è¾“å…¥å¯¹æ–¹çš„ç»‘å®šç "
                               Style="{StaticResource MaterialEntry}" />
                    </Frame>
                </StackLayout>

                <!-- æ˜µç§°è¾“å…¥ -->
                <StackLayout Spacing="8">
                    <Label Text="å¤‡æ³¨æ˜µç§°"
                           Style="{StaticResource MaterialSubtitle1}" />
                    <Frame Style="{StaticResource MaterialCard}">
                        <Entry Text="{Binding NickName}"
                               Placeholder="ä¸ºè¯¥ç”¨æˆ·è®¾ç½®ä¸€ä¸ªæ˜µç§°"
                               Style="{StaticResource MaterialEntry}" />
                    </Frame>
                </StackLayout>

                <!-- é”™è¯¯ä¿¡æ¯ -->
                <Label Text="{Binding ErrorMessage}"
                       TextColor="Red"
                       FontSize="14"
                       IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}" />

                <!-- æ·»åŠ æŒ‰é’® -->
                <Button Text="æ·»åŠ ç”¨æˆ·"
                        Command="{Binding AddUserCommand}"
                        Style="{StaticResource MaterialFAB}"
                        WidthRequest="200"
                        HeightRequest="48"
                        FontSize="16"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}" />

                <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                <ActivityIndicator IsVisible="{Binding IsBusy}"
                                   IsRunning="{Binding IsBusy}"
                                   Color="{StaticResource Primary}"
                                   HorizontalOptions="Center" />
            </StackLayout>
        </Frame>

        <!-- å·²å…³è”ç”¨æˆ·åˆ—è¡¨ -->
        <ScrollView Grid.Row="1">
            <StackLayout Padding="20" Spacing="15">
                
                <!-- åˆ—è¡¨æ ‡é¢˜ -->
                <StackLayout Orientation="Horizontal" Spacing="8">
                    <Label Text="å·²å…³è”ç”¨æˆ·"
                           Style="{StaticResource MaterialHeadline2}"
                           VerticalOptions="Center" />
                    <Label Text="{Binding ConnectedUsers.Count, StringFormat='({0})'}"
                           Style="{StaticResource MaterialBody1}"
                           TextColor="{StaticResource OnSurfaceVariant}"
                           VerticalOptions="Center" />
                    <Button Text="åˆ·æ–°"
                            Command="{Binding RefreshCommand}"
                            Style="{StaticResource MaterialTextButton}"
                            HorizontalOptions="EndAndExpand" />
                </StackLayout>

                <!-- ç”¨æˆ·åˆ—è¡¨ -->
                <StackLayout BindableLayout.ItemsSource="{Binding ConnectedUsers}"
                             Spacing="10">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate x:DataType="services:ConnectedUser">
                            <Frame Style="{StaticResource MaterialCard}">
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    
                                    <!-- ç”¨æˆ·å¤´åƒ -->
                                    <Frame Grid.Column="0"
                                           Style="{StaticResource MaterialAvatar}"
                                           WidthRequest="48"
                                           HeightRequest="48">
                                        <Label Text="{Binding NickName, StringFormat='{0:U1}'}"
                                               Style="{StaticResource MaterialSubtitle1}"
                                               TextColor="{StaticResource PrimaryDarkText}"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Frame>

                                    <!-- ç”¨æˆ·ä¿¡æ¯ -->
                                    <StackLayout Grid.Column="1" 
                                                 Spacing="4" 
                                                 Margin="16,0,0,0"
                                                 VerticalOptions="Center">
                                        <StackLayout Orientation="Horizontal" Spacing="8">
                                            <Label Text="{Binding NickName}"
                                                   Style="{StaticResource MaterialSubtitle1}" />
                                            <Ellipse Style="{Binding IsOnline, Converter={StaticResource BoolToColorConverter}}"
                                                     VerticalOptions="Center" />
                                        </StackLayout>
                                        <Label Text="{Binding LastActiveAt, Converter={StaticResource UtcToLocalTimeStringConverter}, ConverterParameter='æœ€åŽæ´»è·ƒ: MM-dd HH:mm'}"
                                               Style="{StaticResource MaterialCaption}" />
                                        <Label Text="{Binding Location.Address}"
                                               Style="{StaticResource MaterialCaption}"
                                               IsVisible="{Binding Location, Converter={StaticResource StringToBoolConverter}}"
                                               LineBreakMode="TailTruncation" />
                                    </StackLayout>

                                    <!-- åˆ é™¤æŒ‰é’® -->
                                    <Button Grid.Column="2"
                                            Text="ç§»é™¤"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:UserManagementViewModel}}, Path=RemoveUserCommand}"
                                            CommandParameter="{Binding .}"
                                            Style="{StaticResource MaterialOutlinedButton}"
                                            TextColor="Red"
                                            BorderColor="Red"
                                            VerticalOptions="Center" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>

                <!-- ç©ºçŠ¶æ€æç¤º -->
                <StackLayout IsVisible="{Binding ConnectedUsers.Count, Converter={StaticResource InvertedBoolConverter}}"
                             Spacing="20"
                             Margin="0,50,0,0">
                    <Label Text="ðŸ“±"
                           FontSize="48"
                           HorizontalOptions="Center" />
                    <Label Text="è¿˜æ²¡æœ‰å…³è”çš„ç”¨æˆ·"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Gray600}"
                           HorizontalOptions="Center" />
                    <Label Text="è¾“å…¥å¯¹æ–¹çš„ç»‘å®šç æ¥æ·»åŠ ç”¨æˆ·"
                           FontSize="14"
                           TextColor="{StaticResource Gray500}"
                           HorizontalOptions="Center" />
                </StackLayout>

            </StackLayout>
        </ScrollView>
    </Grid>

</ContentPage>