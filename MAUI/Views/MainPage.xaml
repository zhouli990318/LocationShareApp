<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="LocationShareApp.Views.MainPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:maps="clr-namespace:Microsoft.Maui.Controls.Maps;assembly=Microsoft.Maui.Controls.Maps"
             xmlns:viewmodels="clr-namespace:LocationShareApp.ViewModels"
             xmlns:services="clr-namespace:LocationShareApp.Services"
             x:DataType="viewmodels:MainViewModel"
             Title="{Binding Title}">

    <Grid>
        <!-- 地图视图 -->
        <maps:Map x:Name="MapView"
                  IsShowingUser="True"
                  MapType="Street">
            <maps:Map.ItemTemplate>
                <DataTemplate>
                    <maps:Pin Location="{Binding Location}"
                              Address="{Binding Address}"
                              Label="{Binding Label}" />
                </DataTemplate>
            </maps:Map.ItemTemplate>
        </maps:Map>

        <!-- 顶部工具栏 - Material Design风格 -->
        <Frame Style="{StaticResource MaterialTopAppBar}"
               VerticalOptions="Start">
            <Grid ColumnDefinitions="Auto,*,Auto,Auto">
                
                <!-- 用户头像和信息 -->
                <StackLayout Grid.Column="0" 
                             Orientation="Horizontal" 
                             Spacing="12"
                             VerticalOptions="Center">
                    <Frame Style="{StaticResource MaterialAvatar}">
                        <Label Text="{Binding CurrentUser.NickName, StringFormat='{0:U1}'}"
                               Style="{StaticResource MaterialSubtitle1}"
                               TextColor="{StaticResource PrimaryDarkText}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
                    </Frame>
                    <StackLayout Spacing="4">
                        <Label Text="{Binding CurrentUser.NickName}"
                               Style="{StaticResource MaterialSubtitle1}" />
                        <Label Text="{Binding CurrentUser.BindingCode, StringFormat='绑定码: {0}'}"
                               Style="{StaticResource MaterialCaption}" />
                    </StackLayout>
                </StackLayout>

                <!-- 刷新按钮 -->
                <Button Grid.Column="2"
                        Text="刷新"
                        Command="{Binding RefreshCommand}"
                        Style="{StaticResource MaterialTextButton}" />

                <!-- 添加用户按钮 -->
                <Button Grid.Column="3"
                        Text="+"
                        Command="{Binding AddUserCommand}"
                        Style="{StaticResource MaterialMiniFAB}" />
            </Grid>
        </Frame>

        <!-- 底部用户列表 - Material Design风格 -->
        <Frame Style="{StaticResource MaterialBottomNavigation}"
               VerticalOptions="End"
               HeightRequest="240">
            <Grid RowDefinitions="Auto,*">
                
                <!-- 列表标题 -->
                <StackLayout Grid.Row="0" 
                             Orientation="Horizontal" 
                             Padding="20,16,20,12"
                             Spacing="8">
                    <Label Text="关联用户"
                           Style="{StaticResource MaterialHeadline2}" />
                    <Label Text="{Binding ConnectedUsers.Count, StringFormat='({0})'}"
                           Style="{StaticResource MaterialBody1}"
                           TextColor="{StaticResource OnSurfaceVariant}"
                           VerticalOptions="Center" />
                </StackLayout>

                <!-- 用户列表 -->
                <CollectionView Grid.Row="1"
                                ItemsSource="{Binding ConnectedUsers}"
                                SelectionMode="None">
                    <CollectionView.ItemsLayout>
                        <LinearItemsLayout Orientation="Vertical" ItemSpacing="1" />
                    </CollectionView.ItemsLayout>
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="services:ConnectedUser">
                            <Grid Style="{StaticResource MaterialListItem}" 
                                  ColumnDefinitions="Auto,*,Auto,Auto">
                                <Grid.GestureRecognizers>
                                    <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MainViewModel}}, Path=UserTappedCommand}"
                                                          CommandParameter="{Binding .}" />
                                </Grid.GestureRecognizers>

                                <!-- 用户头像 -->
                                <Frame Grid.Column="0"
                                       Style="{StaticResource MaterialAvatar}"
                                       WidthRequest="48"
                                       HeightRequest="48">
                                    <Label Text="{Binding NickName, StringFormat='{0:U1}'}"
                                           Style="{StaticResource MaterialSubtitle1}"
                                           TextColor="{StaticResource PrimaryDarkText}"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />
                                </Frame>

                                <!-- 用户信息 -->
                                <StackLayout Grid.Column="1" 
                                             Spacing="4" 
                                             Margin="16,0,0,0"
                                             VerticalOptions="Center">
                                    <StackLayout Orientation="Horizontal" Spacing="8">
                                        <Label Text="{Binding NickName}"
                                               Style="{StaticResource MaterialSubtitle1}" />
                                        <Ellipse Style="{Binding IsOnline, Converter={StaticResource BoolToColorConverter}}"
                                                 VerticalOptions="Center" />
                                    </StackLayout>
                                    <Label Text="{Binding Location.Address}"
                                           Style="{StaticResource MaterialBody2}"
                                           TextColor="{StaticResource OnSurfaceVariant}"
                                           IsVisible="{Binding Location, Converter={StaticResource StringToBoolConverter}}" />
                                </StackLayout>

                                <!-- 电量信息 -->
                                <StackLayout Grid.Column="2" 
                                             Spacing="2"
                                             VerticalOptions="Center"
                                             IsVisible="{Binding Battery, Converter={StaticResource StringToBoolConverter}}">
                                    <Label Text="{Binding Battery.Level, StringFormat='{0}%'}"
                                           Style="{StaticResource MaterialBody2}"
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center" />
                                    <Label Text="{Binding Battery.IsCharging, StringFormat='{0}'}"
                                           Style="{StaticResource MaterialCaption}"
                                           TextColor="{StaticResource Secondary}"
                                           HorizontalOptions="Center">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding Battery.IsCharging}" Value="True">
                                                <Setter Property="Text" Value="充电中" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="Label" Binding="{Binding Battery.IsCharging}" Value="False">
                                                <Setter Property="Text" Value="" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>
                                </StackLayout>

                                <!-- 箭头图标 -->
                                <Label Grid.Column="3"
                                       Text="›"
                                       Style="{StaticResource MaterialBody1}"
                                       TextColor="{StaticResource OnSurfaceVariant}"
                                       VerticalOptions="Center" />
                            </Grid>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </Frame>

        <!-- 加载指示器 -->
        <ActivityIndicator IsVisible="{Binding IsBusy}"
                           IsRunning="{Binding IsBusy}"
                           Color="{StaticResource Primary}"
                           BackgroundColor="#80000000"
                           HorizontalOptions="Center"
                           VerticalOptions="Center" />
    </Grid>

</ContentPage>