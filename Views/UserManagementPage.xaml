<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="LocationShareApp.Views.UserManagementPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:LocationShareApp.ViewModels"
             x:DataType="viewmodels:UserManagementViewModel"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,*">
        
        <!-- æ·»åŠ ç”¨æˆ·è¡¨å• -->
        <Frame Grid.Row="0"
               BackgroundColor="White"
               CornerRadius="0"
               HasShadow="True"
               Padding="20">
            <StackLayout Spacing="15">
                
                <Label Text="æ·»åŠ æ–°ç”¨æˆ·"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{StaticResource Gray900}" />

                <!-- ç»‘å®šç è¾“å…¥ -->
                <StackLayout Spacing="5">
                    <Label Text="ç»‘å®šç "
                           FontSize="14"
                           TextColor="{StaticResource Gray700}"
                           FontAttributes="Bold" />
                    <Frame BackgroundColor="{StaticResource Gray100}"
                           BorderColor="{StaticResource Gray300}"
                           CornerRadius="10"
                           Padding="0"
                           HasShadow="False">
                        <Entry Text="{Binding BindingCode}"
                               Placeholder="è¯·è¾“å…¥å¯¹æ–¹çš„ç»‘å®šç "
                               FontSize="16"
                               Margin="15,10" />
                    </Frame>
                </StackLayout>

                <!-- æ˜µç§°è¾“å…¥ -->
                <StackLayout Spacing="5">
                    <Label Text="å¤‡æ³¨æ˜µç§°"
                           FontSize="14"
                           TextColor="{StaticResource Gray700}"
                           FontAttributes="Bold" />
                    <Frame BackgroundColor="{StaticResource Gray100}"
                           BorderColor="{StaticResource Gray300}"
                           CornerRadius="10"
                           Padding="0"
                           HasShadow="False">
                        <Entry Text="{Binding NickName}"
                               Placeholder="ä¸ºè¯¥ç”¨æˆ·è®¾ç½®ä¸€ä¸ªæ˜µç§°"
                               FontSize="16"
                               Margin="15,10" />
                    </Frame>
                </StackLayout>

                <!-- é”™è¯¯ä¿¡æ¯ -->
                <Label Text="{Binding ErrorMessage}"
                       TextColor="Red"
                       FontSize="14"
                       IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}" />

                <!-- æ·»åŠ æŒ‰é’® -->
                <Button Text="æ·»åŠ ç”¨æˆ·"
                        Command="{Binding AddUserCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontSize="16"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="45"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}" />

                <!-- åŠ è½½æŒ‡ç¤ºå™¨ -->
                <ActivityIndicator IsVisible="{Binding IsBusy}"
                                   IsRunning="{Binding IsBusy}"
                                   Color="{StaticResource Primary}"
                                   HorizontalOptions="Center" />
            </StackLayout>
        </Frame>

        <!-- å·²å…³è”ç”¨æˆ·åˆ—è¡¨ -->
        <ScrollView Grid.Row="1">
            <StackLayout Padding="20" Spacing="15">
                
                <!-- åˆ—è¡¨æ ‡é¢˜ -->
                <StackLayout Orientation="Horizontal" Spacing="10">
                    <Label Text="å·²å…³è”ç”¨æˆ·"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Gray900}"
                           VerticalOptions="Center" />
                    <Label Text="{Binding ConnectedUsers.Count, StringFormat='({0})'}"
                           FontSize="16"
                           TextColor="{StaticResource Gray600}"
                           VerticalOptions="Center" />
                    <Button Text="åˆ·æ–°"
                            Command="{Binding RefreshCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Primary}"
                            FontSize="14"
                            Padding="10,5"
                            CornerRadius="10"
                            HorizontalOptions="EndAndExpand" />
                </StackLayout>

                <!-- ç”¨æˆ·åˆ—è¡¨ -->
                <StackLayout BindableLayout.ItemsSource="{Binding ConnectedUsers}"
                             Spacing="10">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <Frame BackgroundColor="White"
                                   CornerRadius="12"
                                   HasShadow="True"
                                   Padding="15">
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    
                                    <!-- ç”¨æˆ·å¤´åƒ -->
                                    <Frame Grid.Column="0"
                                           BackgroundColor="{StaticResource Primary}"
                                           CornerRadius="25"
                                           HeightRequest="50"
                                           WidthRequest="50"
                                           Padding="0"
                                           HasShadow="False">
                                        <Label Text="{Binding NickName, StringFormat='{0:C1}'}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="White"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Frame>

                                    <!-- ç”¨æˆ·ä¿¡æ¯ -->
                                    <StackLayout Grid.Column="1" 
                                                 Spacing="5" 
                                                 Margin="15,0,0,0"
                                                 VerticalOptions="Center">
                                        <StackLayout Orientation="Horizontal" Spacing="10">
                                            <Label Text="{Binding NickName}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Gray900}" />
                                            <Ellipse Fill="{Binding IsOnline, Converter={StaticResource BoolToColorConverter}}"
                                                     WidthRequest="8"
                                                     HeightRequest="8"
                                                     VerticalOptions="Center" />
                                        </StackLayout>
                                        <Label Text="{Binding LastActiveAt, StringFormat='æœ€åŽæ´»è·ƒ: {0:MM-dd HH:mm}'}"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}" />
                                        <Label Text="{Binding Location.Address}"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray500}"
                                               IsVisible="{Binding Location, Converter={StaticResource StringToBoolConverter}}"
                                               LineBreakMode="TailTruncation" />
                                    </StackLayout>

                                    <!-- åˆ é™¤æŒ‰é’® -->
                                    <Button Grid.Column="2"
                                            Text="ç§»é™¤"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:UserManagementViewModel}}, Path=RemoveUserCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="Transparent"
                                            TextColor="Red"
                                            FontSize="14"
                                            Padding="10,5"
                                            CornerRadius="8"
                                            BorderColor="Red"
                                            BorderWidth="1"
                                            VerticalOptions="Center" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>

                <!-- ç©ºçŠ¶æ€æç¤º -->
                <StackLayout IsVisible="{Binding ConnectedUsers.Count, Converter={StaticResource InvertedBoolConverter}}"
                             Spacing="20"
                             Margin="0,50,0,0">
                    <Label Text="ðŸ“±"
                           FontSize="48"
                           HorizontalOptions="Center" />
                    <Label Text="è¿˜æ²¡æœ‰å…³è”çš„ç”¨æˆ·"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Gray600}"
                           HorizontalOptions="Center" />
                    <Label Text="è¾“å…¥å¯¹æ–¹çš„ç»‘å®šç æ¥æ·»åŠ ç”¨æˆ·"
                           FontSize="14"
                           TextColor="{StaticResource Gray500}"
                           HorizontalOptions="Center" />
                </StackLayout>

            </StackLayout>
        </ScrollView>
    </Grid>

</ContentPage>