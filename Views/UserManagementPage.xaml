<?xml version="1.0" encoding="utf-8" ?>
<ContentPage x:Class="LocationShareApp.Views.UserManagementPage"
             xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:LocationShareApp.ViewModels"
             x:DataType="viewmodels:UserManagementViewModel"
             Title="{Binding Title}">

    <Grid RowDefinitions="Auto,*">
        
        <!-- 添加用户表单 -->
        <Frame Grid.Row="0"
               BackgroundColor="White"
               CornerRadius="0"
               HasShadow="True"
               Padding="20">
            <StackLayout Spacing="15">
                
                <Label Text="添加新用户"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="{StaticResource Gray900}" />

                <!-- 绑定码输入 -->
                <StackLayout Spacing="5">
                    <Label Text="绑定码"
                           FontSize="14"
                           TextColor="{StaticResource Gray700}"
                           FontAttributes="Bold" />
                    <Frame BackgroundColor="{StaticResource Gray100}"
                           BorderColor="{StaticResource Gray300}"
                           CornerRadius="10"
                           Padding="0"
                           HasShadow="False">
                        <Entry Text="{Binding BindingCode}"
                               Placeholder="请输入对方的绑定码"
                               FontSize="16"
                               Margin="15,10" />
                    </Frame>
                </StackLayout>

                <!-- 昵称输入 -->
                <StackLayout Spacing="5">
                    <Label Text="备注昵称"
                           FontSize="14"
                           TextColor="{StaticResource Gray700}"
                           FontAttributes="Bold" />
                    <Frame BackgroundColor="{StaticResource Gray100}"
                           BorderColor="{StaticResource Gray300}"
                           CornerRadius="10"
                           Padding="0"
                           HasShadow="False">
                        <Entry Text="{Binding NickName}"
                               Placeholder="为该用户设置一个昵称"
                               FontSize="16"
                               Margin="15,10" />
                    </Frame>
                </StackLayout>

                <!-- 错误信息 -->
                <Label Text="{Binding ErrorMessage}"
                       TextColor="Red"
                       FontSize="14"
                       IsVisible="{Binding ErrorMessage, Converter={StaticResource StringToBoolConverter}}" />

                <!-- 添加按钮 -->
                <Button Text="添加用户"
                        Command="{Binding AddUserCommand}"
                        BackgroundColor="{StaticResource Primary}"
                        TextColor="White"
                        FontSize="16"
                        FontAttributes="Bold"
                        CornerRadius="10"
                        HeightRequest="45"
                        IsEnabled="{Binding IsBusy, Converter={StaticResource InvertedBoolConverter}}" />

                <!-- 加载指示器 -->
                <ActivityIndicator IsVisible="{Binding IsBusy}"
                                   IsRunning="{Binding IsBusy}"
                                   Color="{StaticResource Primary}"
                                   HorizontalOptions="Center" />
            </StackLayout>
        </Frame>

        <!-- 已关联用户列表 -->
        <ScrollView Grid.Row="1">
            <StackLayout Padding="20" Spacing="15">
                
                <!-- 列表标题 -->
                <StackLayout Orientation="Horizontal" Spacing="10">
                    <Label Text="已关联用户"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Gray900}"
                           VerticalOptions="Center" />
                    <Label Text="{Binding ConnectedUsers.Count, StringFormat='({0})'}"
                           FontSize="16"
                           TextColor="{StaticResource Gray600}"
                           VerticalOptions="Center" />
                    <Button Text="刷新"
                            Command="{Binding RefreshCommand}"
                            BackgroundColor="Transparent"
                            TextColor="{StaticResource Primary}"
                            FontSize="14"
                            Padding="10,5"
                            CornerRadius="10"
                            HorizontalOptions="EndAndExpand" />
                </StackLayout>

                <!-- 用户列表 -->
                <StackLayout BindableLayout.ItemsSource="{Binding ConnectedUsers}"
                             Spacing="10">
                    <BindableLayout.ItemTemplate>
                        <DataTemplate>
                            <Frame BackgroundColor="White"
                                   CornerRadius="12"
                                   HasShadow="True"
                                   Padding="15">
                                <Grid ColumnDefinitions="Auto,*,Auto">
                                    
                                    <!-- 用户头像 -->
                                    <Frame Grid.Column="0"
                                           BackgroundColor="{StaticResource Primary}"
                                           CornerRadius="25"
                                           HeightRequest="50"
                                           WidthRequest="50"
                                           Padding="0"
                                           HasShadow="False">
                                        <Label Text="{Binding NickName, StringFormat='{0:C1}'}"
                                               FontSize="18"
                                               FontAttributes="Bold"
                                               TextColor="White"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Frame>

                                    <!-- 用户信息 -->
                                    <StackLayout Grid.Column="1" 
                                                 Spacing="5" 
                                                 Margin="15,0,0,0"
                                                 VerticalOptions="Center">
                                        <StackLayout Orientation="Horizontal" Spacing="10">
                                            <Label Text="{Binding NickName}"
                                                   FontSize="16"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Gray900}" />
                                            <Ellipse Fill="{Binding IsOnline, Converter={StaticResource BoolToColorConverter}}"
                                                     WidthRequest="8"
                                                     HeightRequest="8"
                                                     VerticalOptions="Center" />
                                        </StackLayout>
                                        <Label Text="{Binding LastActiveAt, StringFormat='最后活跃: {0:MM-dd HH:mm}'}"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray600}" />
                                        <Label Text="{Binding Location.Address}"
                                               FontSize="12"
                                               TextColor="{StaticResource Gray500}"
                                               IsVisible="{Binding Location, Converter={StaticResource StringToBoolConverter}}"
                                               LineBreakMode="TailTruncation" />
                                    </StackLayout>

                                    <!-- 删除按钮 -->
                                    <Button Grid.Column="2"
                                            Text="移除"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:UserManagementViewModel}}, Path=RemoveUserCommand}"
                                            CommandParameter="{Binding .}"
                                            BackgroundColor="Transparent"
                                            TextColor="Red"
                                            FontSize="14"
                                            Padding="10,5"
                                            CornerRadius="8"
                                            BorderColor="Red"
                                            BorderWidth="1"
                                            VerticalOptions="Center" />
                                </Grid>
                            </Frame>
                        </DataTemplate>
                    </BindableLayout.ItemTemplate>
                </StackLayout>

                <!-- 空状态提示 -->
                <StackLayout IsVisible="{Binding ConnectedUsers.Count, Converter={StaticResource InvertedBoolConverter}}"
                             Spacing="20"
                             Margin="0,50,0,0">
                    <Label Text="📱"
                           FontSize="48"
                           HorizontalOptions="Center" />
                    <Label Text="还没有关联的用户"
                           FontSize="18"
                           FontAttributes="Bold"
                           TextColor="{StaticResource Gray600}"
                           HorizontalOptions="Center" />
                    <Label Text="输入对方的绑定码来添加用户"
                           FontSize="14"
                           TextColor="{StaticResource Gray500}"
                           HorizontalOptions="Center" />
                </StackLayout>

            </StackLayout>
        </ScrollView>
    </Grid>

</ContentPage>